---
title: "MCM"
output:
  html_document:
    toc: true
    toc_depth: 5
    
---

# Propagación de incertidumbres aplicando el método de Monte carlo 

Aplicable a un modelo con cualquier número de magnitudes de entrada y una sola magnitud de salida, parte de un muestreo aleatorio de distribuciones de probabilidad. es una alternativa práctica al enfoque GUM,  se aplica cuando:

- El modelo es no lineal

- La FDP para la magnitud de salida se aparta de una normal o de una t, debido a una marcada asimetría.

- Es difícil proporcionar las derivadas parciales del modelo, tal como requiere la ley de propagación de la incertidumbre

- Los modelos son arbitrariamente complicados

"El método MCM es aplicado para comprobar el marco de referencia GUM"


```{r, echo=F, out.width="50%", fig.align='center'}
knitr::include_graphics("imagen/compa.png")
```

**Comparación**


```{r, echo=F, out.width="80%", fig.align='center'}
knitr::include_graphics("imagen/gumvsmcm.png")
```


**Recorderis**
Demostración:

la incertidumbre tipo A proviene de la incertidumbre del promedio


$$\bar x=\frac{x_1+x_2+x_3+...+x_n}{n}$$

vamos a obtener su incertidumbre:


$$u(\bar x)=\sqrt{\left (\frac{1}{n}*u(x_1)\right)^2+\left (\frac{1}{n}*u(x_2)\right)^2+...+\left (\frac{1}{n}*u(x_n)\right)^2}$$

$$u(\bar x)=\sqrt{n \left (\frac{1}{n}*s\right)^2}$$


$$u(\bar x)=\sqrt{ \frac{n}{n^2}*s^2}$$


$$u(\bar x)=\sqrt{ \frac{n}{n^2}*s^2}$$

$$u(\bar x)= \frac{s}{\sqrt{n}}$$





**¿Cuántas simulaciones son necesarias?**

Según GUM S1 (2008) Un valor de $M = 10^6$ suele proporcionar un intervalo de cobertura del 95 % para la magnitud de salida, de forma que la amplitud del intervalo es correcta con una o dos cifras decimales significativas.




$$ \begin{cases}
N>>\frac{1}{1-p},
& \\
N>10^4\frac{1}{1-p}, 
\end{cases} $$

$N>219781$
donde p es el área de cobertura usualmente p=95.45%

# Simulación de las distribuciones de probabilidad


## Distribución rectangular ó uniforme


En una distribución rectangular cada valor en un intervalo dado tiene la misma probabilidad, o sea la función de densidad de probabilidad es constante en este intervalo. 

Sea $X∼U(a,b)$, es decir, una variable aleatoria con distribución uniforme en el intervalo  (a,b), con $a,b \quad \varepsilon \quad \mathbb{R}$:


|Descripción|b y a con b>a| a y -a [centrada en cero]|
|:----------|:------------------:|:--------------:|
|fdp f(x)   |$\frac{1}{b-a}$     |$\frac{1}{2a}$  |
|F(x)       |$\frac{x-a}{b-a}$   |$\frac{x-a}{2a}$|
|prom E(X)  |$\frac{a+b}{2}$     |0               |
|$E(x^2)$   |$\frac{b^2+ba+a^2}{3}$        |$\frac{a^2}{3}$ |
|v(x)       |$\frac{(b-a)^2}{12}$|$\frac{a^2}{3}$ |
|sd=u(x)    |$\frac{(b-a)}{\sqrt{12}}$|$\frac{a}{\sqrt3}$|



El rango de una distribución de probabilidad se refiere al conjunto de todos los posibles valores que puede tomar una variable aleatoria en esa distribución. Es la diferencia entre el valor máximo y el valor mínimo de esta variable.



**Simulación de la distribución uniforme**

```{r  out.width="50%"}
## runif(n, min = 0, max = 1)

y=runif(n=1e6,min=-1,max=1)

hist(y)
```

**simulemos los resultados de una incertidumbre por resolución**

$$u=\frac{a}{\sqrt 3}=\frac{1}{\sqrt 3}=0.577350 $$
a es la semiamplitud=1, criterio necesario para definir la simulación 


```{r out.width="50%"}

y=runif(n=1e6,min=0,max=2)
sd(y)
hist(y)



```


**Simulando la incertidumbre tipo A** 

como la desviación estándar proviene de una distribución uniforme hacemos uso de esta misma para la estimación de la incertidumbre. 


$$u=\frac{s}{\sqrt {10}}=\frac{0.5773}{10}=0.182574$$

```{r}
ysum=0
for(y in 1:10){
  y=runif(n=1e6,min=-1,max=1)
  ysum=ysum+y
}

y=(ysum)/10
sd(y)


```




## Distribución triangular

Generar una variable aleatoria continua con distribución triangular con parámetros a=-2 y b=2

```{r  out.width="50%"}


u1<-runif(1e6,0,1)
u2<-runif(1e6,0,1)
m=0 # centro de la distribuciòn
a=2 # semiamplitud de la distribuciòn
x=m+(a*(u1+u2-1))
hist(x)

```

## Distribución normal

```{r  out.width="50%"}
#rnorm(n, mean = 0, sd = 1)

y=rnorm(1e6, mean = 0, sd = 1)

hist(y)


```

## Distribución t de student

```{r out.width="50%"}

# rt(n, df, ncp)

ncp <- seq(0, 6, length.out = 31)

y=rt(1e6, df=8, ncp)

hist(y)

```


**Propagación de incertidumbres** GUM


**Propagación de distribuciones** MCM


**Ejemplo**

considere la siguiente ecuación que describe al mensurando

$$y=f(x_1,x_2,x_3)=5x_1-3x_2+x_3 $$

$$x_1= uniforme\quad u_{x_1}=\frac{1}{\sqrt 3}=0.5773$$
$$x_2=triangular= \quad u_{x_2}=\frac{1}{\sqrt 6}=0.4082$$

$$x_3=normal\quad u_{x_3}=1$$

**Por la GUM**

$$u_C^2(y)=\sum_{i=1}^N c_i^2u^2(x_i)$$

$$u(y)=\sqrt{(5*u(x_1))^2+(3*u(x_2))^2+(u(x_3))^2}=3.29$$

**Por MCM**

```{r out.width="80%"}
#distri1
x1=runif(n=1e6,min=-1,max=1)

#distri2
u1<-runif(1e6,0,1)
u2<-runif(1e6,0,1)
m=0 # centro de la distribuciòn
a=1 # semiamplitud de la distribuciòn
x2=m+(a*(u1+u2-1))

#distr3
x3=rnorm(1e6, mean = 0, sd = 1)

y=(5*x1)-(3*x2)+(x3)

mean(y)
par(mfrow=c(1,4))
sd(y)

hist(x1)
hist(x2)
hist(x3)
hist(y)

```


**Estimación incertidumbre con la función propagate de la librería propagate**



```{r message=FALSE}
library(propagate)
```


```{r }

## Usando la función propagate

EXPR1 <- expression((5*x1)-(3*x2)+x3)
x1 <- c(1,0.5773)
x2 <- c(1,0.4082)
x3 <- c(1,1)
DF1 <- cbind(x1,x2,x3)
RES1 <- propagate(expr = EXPR1, data = DF1, type = "stat",
                  do.sim = TRUE, verbose = TRUE)
summary(RES1)

```

## ¿Cuál distribución de probabilidad se ajusta mejor a los datos?


**AIC**
$$AIC = -2 * log(L) + 2 * k$$
**BIC**
$$BIC = -2 * log(L) + k * log(n)$$

L representa la probabilidad maximizada del modelo, que mide qué tan bien se ajusta el modelo a los datos. 

k representa el número de parámetros en el modelo

log(n) representa el logaritmo del tamaño de la muestra (n)



```{r}
#busca cual distribución es la q mejor se ajusta
fitDistr(RES1)
```

**¿Cómo realizar una simulaciòn de la incertidumbre por el metodo monte carlo cuando hay correlaciòn entre variables?**

Matriz de covarianzas

$$\begin{bmatrix} 
u_1^2(xi) & u(x_1)u(x_2)r(x_1,x_2)\\ 
u(x_2)u(x_1)r(x_2,x_1) & u_2^2(x_2)\\
\end{bmatrix}$$

**Matriz de transformación R**


Para incluir la correlación y desviación estándar de cada magnitud de entrada
descomposiciòn de cholesky para a matriz de covarianza
$$Cov(X)=R^TR$$, esta matriz debe ser no definida positiva




**El ejercicio del parcial hecho en R**

```{r }
library(propagate)
## => Normal distribution.
EXPR1 <- expression((1-(x/y))*100)
x <- c(165.52,23.45)
y <- c(1589.64,0.51)
DF1 <- cbind(x, y)
RES1 <- propagate(expr = EXPR1, data = DF1, type = "stat",
                  do.sim = TRUE, verbose = TRUE)

summary(RES1)

```

```{r results='markup'}
fitDistr(RES1)
```




# Bibliografía

GUM S1. (2008). JCGM 101:2008 Evaluación de datos de medición-Suplemento 1 de la “Guía para la expresión de la incertidumbre de medida”-Propagación de distribuciones aplicando el método de Monte Carlo. www.cem.es,
